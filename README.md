[English Version](README.en.md)

# Node Explorer for DaVinci Resolve/Fusion

## `NodeExplorer` は何？  
* DaVinci ResolveのFusionページで使用するために作成された**カスタムノード**です。Fusion標準の `AlphaDivide` ノードをベースに、カスタムコントロールと内部ライブラリを追加しています。  
* マクロの開発時などに、ノード、コントロール、およびそれらの属性を手軽に検査・分析することを目的としています。
* 本ツールはレンダリングには参加しません。また、使用後にコンポジションからいつ削除しても問題ありません。

## 主な機能

*   **Node**: コンポジション内の全ノードまたは選択したノードのリストを、`RegID`、`Visible`、`PassThrough`などの情報と共に表示します。
*   **Control**: 指定したノード内のコントロール（UI要素）を一覧表示します。コントロールの種類（`SliderControl`、`ButtonControl`など）でフィルタリングできます。
*   **Attrs**: 特定のコントロールが持つすべての属性（`GetAttrs()`で取得できる情報）を詳細に表示します。
*   **Script**: コントロールに設定されているスクリプト（`Expression`、`OnChange`など）を簡単に取得・表示します。
*   **出力形式の選択**: 検査結果をプレーンテキスト、HTMLテーブル、CSV形式で表示・コピーできます。
*   **Clipboard**: 全ての出力結果をワンクリックでクリップボードにコピーできます。また、クリップボードの内容を確認するための簡易的なビューアも搭載しています。

## インストール方法

`NodeExplorer_ver0.1.setting` ファイルを任意の場所に保存し、Fusionページのノードエディタに直接ドラッグ＆ドロップすることで使用できます。

繰り返し使用する場合は、DaVinci ResolveのMacrosフォルダにファイルを配置することで、`エフェクト`パネルからいつでも呼び出せるようになります。
*   **Windows**: `%APPDATA%\Blackmagic Design\DaVinci Resolve\Support\Fusion\Macros\`
*   **macOS**: `~/Library/Application Support/Blackmagic Design/DaVinci Resolve/Fusion/Macros/`
*   **Linux**: `~/.local/share/DaVinciResolve/Fusion/Macros/`

## 目次

- [各機能の使い方](#各機能の使い方)
  - [Explorer タブ](#explorer-タブ)
  - [Status タブ](#status-タブ)
- [各出力フォーマットの用途](#各出力フォーマットの用途)
- [処理フローとキャッシュについて](#処理フローとキャッシュについて)
- [バージョン履歴](#バージョン履歴)
- [技術的な注意事項](#技術的な注意事項)
- [免責事項](#免責事項)
- [ライセンスと再配布について](#ライセンスと再配布について)

## 各機能の使い方

### 初回起動時及び再起動時
`NodeExplorer` は初回起動時及び再起動時に初期化の手順が必要になります。  
まず初めに`POWER`ボタンを押してください。正しく初期化が行われるとUIが表示されます。

![POWERボタン](images/Power_Btn.png)
### タブ構成
`NodeExplorer` は `Explorer` と `Status` の2つのタブで構成されています。  
また、`Explorer`タブには上部にセクション表示ボタンを設置しています。  
表示したいセクションを選択( **複数選択可能** )して表示する事が出来ます。

### Explorer タブ

#### 1. Node セクション
コンポジション内のノードに関する情報を取得します。

![Nodeセクション](images/Node_Section.png)  

*   **Scope**: `All`（すべてのノード）か `Selected`（選択中のノード）を選択します。
*   **Format**: 出力形式を `TXT`、`HTML`、`CSV` から選択します。
*   **Update**: 設定に基づいてノード情報を収集し、下のテキストボックスに表示します。
*   **Copy**: テキストボックスの内容をクリップボードにコピーします。
*   **Clear**: テキストボックスの内容をクリアします。

#### 2. Control セクション
ノードが持つコントロール（インスペクター上のUI）に関する情報を取得します。

![Controlセクション](images/Control_Section.png)  

*   **Input**: 調査したいコントロールの種類を選択します（例: `SliderControl`）。`All` を選択するとすべての種類が対象になります。
*   **Scope**: `All`（すべてのノード）か `Selected`（選択中のノード）を選択します。
*   **Format**: 出力形式を選択します。
*   **Update**: 設定に基づいてコントロール情報を収集し、表示します。

#### 3. Attrs セクション

特定のコントロールが持つ属性（Attributes）を詳細に調査します。

![Attrsセクション](images/Attrs_Section.png)

*   **Target**: `ToolName.InputID` の形式で調査対象を指定します。（例: `Background1.TopLeftRed`）
*   **Active**: 現在アクティブな（最後にクリックした）ノードの名前を `Target` フィールドに自動入力します。
*   **Pickup**: 右クリックからExpressionを選択し、`+` アイコンをドラッグしてインスペクター上のコントロールにドロップすることで、`Target` フィールドへ自動入力できます。（Expressionを利用した機能）
*   **Format**: 出力形式を選択します。
*   **Update**: `Target` で指定されたコントロールの属性情報を収集し、表示します。

#### 4. Script セクション

コントロールに紐づけられたスクリプトを取得します。

![Scriptセクション](images/Script_Section.png)

*   **Target**: `Attrs`セクションと同様に、対象のコントロールを `ToolName.InputID` 形式で指定します。
*   **ScriptType**: 取得したいスクリプトの種類を選択します。
    -   `Expression`: Expressionに設定されたスクリプト。
    -   `Execute On Change`: INPS_ExecuteOnChange に設定されたスクリプト。
    -   `Button Execute (UserControl)`: UserControlのボタンに設定された BTNCS_Execute スクリプト。
*   **Get**: スクリプトを取得し、表示します。

#### 5. Clipboard セクション

クリップボードの内容を確認するためのシンプルなビューアです。

![Clipboadセクション](images/Clipboad_Section.png)

*   **Paste**: 現在のクリップボードの内容をビューアに貼り付けます。
*   **Clear**: ビューアの内容をクリアします。

### Status タブ

ツールの内部状態やキャッシュ情報を確認できます。

![Statusタブ](images/Status_Tab.png)

*   **Cache Data**: `NodeExplorer` は一度生成したリストやフォーマット済みテキストをキャッシュし、再表示を高速化します。このセクションでは、各データのキャッシュ状況（`●`: あり / `○`: なし）を確認したり、個別にキャッシュをクリアしたりできます。`Clear All Caches` ですべてのキャッシュを一度に削除できます。
*   **Library Loading**: ツール内部のライブラリの読み込み状態を表示します。正常に読み込まれている場合は "Loading success" と表示されます。
*   **Reload Library**: 何らかの原因でライブラリの読み込みに失敗した場合に再読み込みを行います。正常に読み込まれている場合には無効化されています。

## 各出力フォーマットの用途

### プレーンテキスト (TXT)
デフォルトのフォーマットです。シンプルなテキストで情報を確認できます。ツール内でターゲットを指定するためにノード名などをコピー＆ペーストする用途にも適しています。

クリップボード経由で外部のテキストエディタに貼り付けて使用することも想定しています。複数のノードの情報がある場合、テキストエディタの検索機能で `*****` (アスタリスク5個) を検索すると、ノードごとの情報に素早くジャンプできます。

### HTML
ツール内のクリップボードビューアで簡易的に表示することを主な利用目的としたフォーマットです。各セクションのテキストボックスにはHTMLソースが表示されるため、コピーして利用します。

また、クリップボードにコピーしたHTMLソースを外部ブラウザで表示することも可能です。その際、以下のJavaScriptコードをブラウザのブックマーク（ブックマークレット）として登録しておくと便利です。

```javascript
javascript: (function() {
  navigator.clipboard.readText().then(t => {
    const w = window.open('', '_blank');
    w.document.write(t);
    w.document.close();
  });
})();
```
クリップボードにHTMLソースをコピーした状態でこのブックマークレットを開くと、新しいタブが開き、整形されたテーブルとして内容を閲覧できます。

### CSV
ExcelやGoogleスプレッドシートといった表計算ソフトで利用するためのデータフォーマットです。大量のデータから特定の情報を探したい場合に、ソートやフィルタなど表計算ソフトの強力な機能が利用できます。

以下はGoogleスプレッドシートでの利用手順です。
1.  新規にスプレッドシートを作成します。
2.  本ツールで目的の情報をCSV形式でクリップボードにコピーします。
3.  シートのセルを一つ選択し（通常はA1）、クリップボードの内容を貼り付けます。
4.  貼り付け時にセルの右下に表示されるアイコンをクリックし、メニューから **「テキストを列に分割」** を選択します。
5.  必要に応じて、右クリックメニューなどからテーブルとしての書式設定を行うと、より見やすくなります。

## 処理フローとキャッシュについて

`NodeExplorer` は、パフォーマンス向上のためにキャッシュ機能を積極的に利用しています。`Update`ボタンやフォーマット選択ボタンを押した際の内部的な処理は以下の通りです。

### `Update` ボタンを押した時の処理

1.  **情報収集**: `Scope` の設定（`All` / `Selected`）に基づき、コンポジションからノードやコントロールの情報を収集します。
2.  **リストキャッシュ作成**: 収集した情報をリスト形式のデータ（Luaテーブル）に変換し、ツールの内部データ（CustomData）にキャッシュとして保存します。
3.  **テキスト生成と表示**: 現在選択されている `Format`（`TXT`/`HTML`/`CSV`）に基づき、リストキャッシュから表示用のテキストデータを生成します。
4.  **フォーマットキャッシュ作成**: 生成したテキストデータを、フォーマットごとのキャッシュとして内部データに保存し、テキストボックスに表示します。

### `Format` 選択ボタン（TXT/HTML/CSV）を押した時の処理

1.  **フォーマットキャッシュ確認**: 選択されたフォーマットに対応するテキストデータのキャッシュが存在するか確認します。
2.  **キャッシュ利用**: キャッシュが存在すれば、それを直接テキストボックスに表示します。これにより、再計算の必要がなく高速に表示が切り替わります。
3.  **キャッシュがない場合**:
    *   リストデータのキャッシュ（`Update`ボタンで作成されたもの）が存在するか確認します。
    *   リストキャッシュが存在すれば、それを利用して要求されたフォーマットのテキストデータを新規に生成し、表示します。同時に、新しいフォーマットキャッシュとして保存します。
    *   リストキャッシュも存在しない場合（`Update`を一度も押していない場合など）は、`Update`ボタンを押すよう促すメッセージが表示されます。

これらのキャッシュの状態は `Status` タブで確認・個別にクリアできます。

## バージョン履歴

### ver 0.1 (2025-09-04)

*   最初のリリース

## 技術的な注意事項

*   ツールに内蔵されているクリップボードビューアは、あくまで簡易的な表示を目的としています。
*   FusionのUIレンダリングの特性上、クリップボードビューアに大量のデータを表示しようとすると動作が重くなる場合があります。
*   特にHTMLテーブルは描画コストが高いため、目安として**200行を超えるような大きなテーブル**は、クリップボード経由で外部のWebブラウザで表示することを推奨します。

## 免責事項
*   本ツールの使用によって生じたいかなる損害や障害について、作成者は一切の責任を負いかねます。あらかじめご了承の上、ご自身の責任においてご利用ください。

## ライセンスと再配布について
*   本ツールには特に利用制限を設けません。個人・商用利用、改変、再配布はご自由に行っていただいて構いません。
*   ただし、作成者が本ツールを配布、利用する権利を妨げるものではありません。